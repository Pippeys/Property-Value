---
title: "R Notebook"
output:
  html_notebook: default
  html_document: default
---
## load data 
```{r echo = T, eval=T, warning=FALSE}
library(ggplot2)
library(tidyverse)
library(stringr)


load("Property Value/propers.RData")
head(properties)
```
## clean this dirty data 
look at how much the data shrinks after this cleaning step
we need better data collection
```{r}
## make sure there are no NAs in the columns we care about and select the columns we want 
cleaner <- properties %>% 
  filter(!is.na(`Units`) & `Units` > 0 & !is.na(`Last Price`) & properties$`Square Footage` > 0 & !is.na(properties$`Last Sale`) & !is.na(properties$PropertyType) & !is.na(properties$`Prop Sale GRM`) & !is.na(properties$`Zip Code`) & !is.na(properties$`Square Footage`) & properties$`Prop Sale GRM` > 0) %>% 
  select(`Last Price`, `Last Sale`, PropertyType, `Prop Sale GRM`, `Square Footage`, `Zip Code`, `Units`)
## rename so the names dont suck
names(cleaner) <- c('LastPrice','LastSale','PropertyType','PropSaleGRM', 'Sqft', 'ZipCode', 'Units')
cleaner$PropertyType <- as.factor(cleaner$PropertyType)
cleaner$ZipCode<-strtrim(cleaner$ZipCode, 5)
cleaner$ZipCode <- as.factor(cleaner$ZipCode)
## dims
dim(cleaner)[1]# after
dim(properties)[1] # before
```
How much data de we actually have 
```{r eval = T, echo = T}
summary(cleaner$PropertyType)
summary(cleaner$ZipCode)
```
not much in each category 
so its probably a better idea to check out multifamily only



## plot dis 
```{r}
cleaner %>% 
  filter(PropertyType == 'Multifamily') %>% 
  ggplot(aes(x = PropertyType,y = LastPrice)) + 
  geom_boxplot() + 
  ylim(0, 1000000)

cleaner %>% 
  filter(PropertyType == 'Multifamily') %>% 
  ggplot(aes(x = LastPrice)) + 
  geom_histogram() + 
  xlim(0,10000000)
```
what about GRM
```{r}
cleaner %>% 
  filter(PropertyType == 'Multifamily') %>% 
  ggplot(aes(x = PropSaleGRM)) + 
  geom_histogram() +
  xlim(0,30)
```


##And what about sqft?
```{r}
ggplot(cleaner, aes(x = Sqft)) +
  geom_histogram() +
  xlim(0,200000)

#too many outliers...
```
```{r}
ggplot(cleaner, aes(x = Sqft))+
  geom_histogram()+
  xlim(0,20000)
```
```{r}
cleaner %>% 
  ggplot(aes(x = LastPrice,y = PropSaleGRM)) + 
  geom_point() + 
  ylim(0,25) + 
  xlim(0,3000000) + 
  geom_smooth(method = "lm")
```
```{r}
cleaner %>% 
  ggplot(aes(x = LastPrice/Sqft, y = PropSaleGRM)) + 
  geom_point() + 
  ylim(0,25) + 
  xlim(0,500) + 
  geom_smooth(method = "lm")
```
```{r}
ggplot(cleaner, aes(x = LastPrice/Sqft)) +
geom_histogram() +
xlim(0,1000)

```


```{r}
cleaner %>% 
  filter(ZipCode == "94704") %>% 
  ggplot(aes(x = LastPrice, y = PropSaleGRM)) + 
  geom_point() + 
  geom_smooth(method = "lm")
berk_mod1 <- lm(PropSaleGRM ~ LastPrice, data = filter(cleaner, ZipCode == "94704"))
summary(berk_mod1)
```
Might be a good idea to bin by square footage to remove really big properties where we dont have enough power to acurately estimate the factors that might be driving GRM

```{r}
cleaner %>%
  filter(ZipCode == "94704") %>% 
  ggplot(aes(x = PropSaleGRM, y = log(LastPrice))) +
  geom_point() +
  geom_smooth(method = "lm")
#berk_mod2 <- lm(log(LastPrice) ~ PropSaleGRM, data = filter(cleaner, ZipCode == "97404"))
```


## We see an awesome correlation here with ln(LastPrice) & ln(SqFt)
This is because both are heavily skewed left and thus a nature log transformation should normalize the data.
```{r}
cleaner %>%
  filter(ZipCode == "94704") %>% 
  ggplot(aes(x = log(Sqft), y = log(LastPrice))) +
  geom_point() +
  geom_smooth(method = "lm")
```

```{r}
berk_mod3 <- lm(formula = log(LastPrice) ~ log(Sqft), data = filter(cleaner, ZipCode == "94704"))
#summary(berk_mod2,)
anova(berk_mod3)
summary(berk_mod3)
```

#### I'm guessing the best model will be: lm(log(LastPrice)~log(SqFt)+ZipCode+LastSale+PropSaleGRM)

```{r}
cleaner %>%
  filter(ZipCode == "94704") %>%
  ggplot(aes(x = PropSaleGRM)) +
  geom_histogram() 
```

```{r}
cleaner %>% 
  filter(ZipCode == "94541") %>% 
  ggplot(aes(x = PropSaleGRM)) +
  geom_histogram()
```

```{r}
cleaner %>% 
  filter(ZipCode == "94501") %>% 
  ggplot(aes(x = PropSaleGRM)) +
  geom_histogram()
```

```{r}
Berk_mod4 <- lm(log(LastPrice) ~ PropSaleGRM + log(Sqft) + LastSale, Units, data = filter(cleaner,ZipCode == "94704")) 
summary(Berk_mod4)
lean_berkey<- step(lm(log(LastPrice) ~ PropSaleGRM * log(Sqft) * LastSale * Units, data = filter(cleaner, ZipCode == "94704")), direction = "both")
summary(lean_berkey)
plot(lean_berkey)
```

###Let's go to a larger model
Include all ZipCodes

```{r}
True_mod1 <- step(lm(log(LastPrice) ~ PropSaleGRM * log(Sqft) * LastSale * Units * ZipCode, data = cleaner), direction = "both")
summary(True_mod1)
plot(True_mod1)
```

